// This is your Prisma schema file for Billing Service
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("BILLING_DATABASE_URL")
}

// ===========================================
// CORE BILLING MODELS
// ===========================================

model User {
  id                String    @id @default(uuid())
  email             String    @unique
  firstName         String?   @map("first_name")
  lastName          String?   @map("last_name")
  isActive          Boolean   @default(true) @map("is_active")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")
  
  // Billing relations
  balance           UserBalance?
  transactions      Transaction[]
  usageEvents       UsageEvent[]
  invoices          Invoice[]
  subscriptions     Subscription[]
  paymentMethods    PaymentMethod[]
  discountRules     DiscountRule[]
  
  @@map("users")
}

model UserBalance {
  id                String    @id @default(uuid())
  userId            String    @unique @map("user_id")
  balance           Decimal   @default(0) @db.Decimal(10, 4)
  currency          String    @default("USD")
  creditLimit       Decimal?  @map("credit_limit") @db.Decimal(10, 2)
  lastUpdated       DateTime  @default(now()) @map("last_updated")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")
  
  // Relations
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("user_balances")
}

model Transaction {
  id                String            @id @default(uuid())
  userId            String            @map("user_id")
  type              TransactionType
  amount            Decimal           @db.Decimal(10, 4)
  currency          String            @default("USD")
  description       String?
  status            TransactionStatus @default(PENDING)
  reference         String?           @unique
  metadata          Json?
  processedAt       DateTime?         @map("processed_at")
  createdAt         DateTime          @default(now()) @map("created_at")
  updatedAt         DateTime          @updatedAt @map("updated_at")
  
  // Relations
  user              User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  invoice           Invoice?          @relation(fields: [invoiceId], references: [id])
  invoiceId         String?           @map("invoice_id")
  paymentMethod     PaymentMethod?    @relation(fields: [paymentMethodId], references: [id])
  paymentMethodId   String?           @map("payment_method_id")
  
  @@map("transactions")
  @@index([userId])
  @@index([type])
  @@index([status])
  @@index([createdAt])
}

model UsageEvent {
  id                String            @id @default(uuid())
  userId            String            @map("user_id")
  service            String
  resource           String
  quantity           Int               @default(1)
  unit               String            @default("request")
  cost              Decimal           @db.Decimal(10, 4)
  currency           String            @default("USD")
  metadata           Json?
  timestamp          DateTime          @default(now())
  
  // Relations
  user              User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("usage_events")
  @@index([userId])
  @@index([service])
  @@index([timestamp])
}

model Invoice {
  id                String            @id @default(uuid())
  userId            String            @map("user_id")
  invoiceNumber     String            @unique @map("invoice_number")
  status            InvoiceStatus     @default(DRAFT)
  subtotal          Decimal           @db.Decimal(10, 2)
  tax               Decimal           @default(0) @db.Decimal(10, 2)
  total             Decimal           @db.Decimal(10, 2)
  currency          String            @default("USD")
  dueDate           DateTime          @map("due_date")
  paidAt            DateTime?         @map("paid_at")
  createdAt         DateTime          @default(now()) @map("created_at")
  updatedAt         DateTime          @updatedAt @map("updated_at")
  
  // Relations
  user              User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions      Transaction[]
  invoiceItems      InvoiceItem[]
  
  @@map("invoices")
  @@index([userId])
  @@index([status])
  @@index([dueDate])
}

model InvoiceItem {
  id                String            @id @default(uuid())
  invoiceId         String            @map("invoice_id")
  description       String
  quantity          Int               @default(1)
  unitPrice         Decimal           @map("unit_price") @db.Decimal(10, 2)
  total             Decimal           @db.Decimal(10, 2)
  metadata           Json?
  
  // Relations
  invoice           Invoice           @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  
  @@map("invoice_items")
}

model Subscription {
  id                String            @id @default(uuid())
  userId            String            @map("user_id")
  planId            String            @map("plan_id")
  status            SubscriptionStatus @default(ACTIVE)
  currentPeriodStart DateTime         @map("current_period_start")
  currentPeriodEnd   DateTime         @map("current_period_end")
  price             Decimal           @db.Decimal(10, 2)
  currency          String            @default("USD")
  createdAt         DateTime          @default(now()) @map("created_at")
  updatedAt         DateTime          @updatedAt @map("updated_at")
  
  // Relations
  user              User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("subscriptions")
  @@index([userId])
  @@index([status])
}

model PaymentMethod {
  id                String            @id @default(uuid())
  userId            String            @map("user_id")
  type              PaymentMethodType
  provider          String
  externalId        String            @map("external_id")
  isDefault          Boolean          @default(false) @map("is_default")
  metadata           Json?
  createdAt         DateTime          @default(now()) @map("created_at")
  updatedAt         DateTime          @updatedAt @map("updated_at")
  
  // Relations
  user              User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions      Transaction[]
  
  @@map("payment_methods")
  @@index([userId])
  @@index([type])
}

model PricingPlan {
  id                String            @id @default(uuid())
  name              String
  description       String?
  type              PricingType       @default(SUBSCRIPTION)
  price             Decimal           @db.Decimal(10, 2)
  currency          String            @default("USD")
  billingCycle      BillingCycle      @default(MONTHLY)
  isActive          Boolean           @default(true) @map("is_active")
  limits            Json?
  features          Json?
  createdAt         DateTime          @default(now()) @map("created_at")
  updatedAt         DateTime          @updatedAt @map("updated_at")
  
  @@map("pricing_plans")
  @@index([isActive])
}

model PricingRule {
  id                String            @id @default(uuid())
  name              String
  service           String
  resource          String?
  type              PricingRuleType   @default(PER_UNIT)
  price             Decimal           @db.Decimal(10, 6)
  currency          String            @default("USD")
  limits            Json?
  discounts         Json?
  isActive          Boolean           @default(true) @map("is_active")
  priority          Int               @default(0)
  validFrom         DateTime?         @map("valid_from")
  validTo           DateTime?         @map("valid_to")
  createdAt         DateTime          @default(now()) @map("created_at")
  updatedAt         DateTime          @updatedAt @map("updated_at")
  
  @@map("pricing_rules")
  @@index([service])
  @@index([resource])
  @@index([isActive])
  @@index([priority])
}

model DiscountRule {
  id                String            @id @default(uuid())
  name              String
  code              String?           @unique
  type              DiscountType      @default(PERCENTAGE)
  value             Decimal           @db.Decimal(10, 4)
  currency          String?           @default("USD")
  minAmount         Decimal?          @map("min_amount") @db.Decimal(10, 2)
  maxAmount         Decimal?          @map("max_amount") @db.Decimal(10, 2)
  userId            String?           @map("user_id")
  userTier          String?           @map("user_tier")
  isGlobal          Boolean           @default(false) @map("is_global")
  isActive          Boolean           @default(true) @map("is_active")
  validFrom         DateTime?         @map("valid_from")
  validTo           DateTime?         @map("valid_to")
  usageLimit        Int?              @map("usage_limit")
  usageCount        Int               @default(0) @map("usage_count")
  createdAt         DateTime          @default(now()) @map("created_at")
  updatedAt         DateTime          @updatedAt @map("updated_at")
  
  // Relations
  user              User?             @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  @@map("discount_rules")
  @@index([code])
  @@index([userId])
  @@index([isActive])
  @@index([validFrom])
  @@index([validTo])
}

model CurrencyRate {
  id                String            @id @default(uuid())
  fromCurrency      String            @map("from_currency")
  toCurrency        String            @map("to_currency")
  rate              Decimal           @db.Decimal(10, 6)
  timestamp         DateTime          @default(now())
  
  @@map("currency_rates")
  @@index([fromCurrency])
  @@index([toCurrency])
  @@index([timestamp])
}

// ===========================================
// ENUMS
// ===========================================

enum TransactionType {
  CREDIT
  DEBIT
  REFUND
  CHARGEBACK
}

enum TransactionStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
  REFUNDED
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  OVERDUE
  CANCELLED
}

enum SubscriptionStatus {
  ACTIVE
  INACTIVE
  CANCELLED
  PAST_DUE
}

enum PaymentMethodType {
  CARD
  BANK_ACCOUNT
  WALLET
  CRYPTOCURRENCY
}

enum PricingType {
  SUBSCRIPTION
  USAGE_BASED
  ONE_TIME
  FREEMIUM
}

enum BillingCycle {
  DAILY
  WEEKLY
  MONTHLY
  QUARTERLY
  YEARLY
}

enum PricingRuleType {
  PER_UNIT
  PER_REQUEST
  PER_TOKEN
  PER_MINUTE
  PER_MB
  FIXED
}

enum DiscountType {
  PERCENTAGE
  FIXED_AMOUNT
  FREE_TRIAL
}
