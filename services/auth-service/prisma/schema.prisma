// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
  url      = env("AUTH_DATABASE_URL")
}

model Company {
  id              String    @id @default(uuid())
  name            String
  email           String    @unique
  passwordHash    String    @map("password_hash")
  isActive        Boolean   @default(true) @map("is_active")
  isVerified      Boolean   @default(false) @map("is_verified")
  role            UserRole  @default(company)
  description     String?
  website         String?
  phone           String?
  address         Json?
  settings        Json?
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  lastLoginAt     DateTime? @map("last_login_at")
  metadata        Json?

  // Hierarchy fields
  parentCompanyId String?   @map("parent_company_id")
  billingMode     BillingMode @default(SELF_PAID) @map("billing_mode") // SELF_PAID или PARENT_PAID
  position        String?   // Должность в родительской компании
  department      String?   // Отдел в родительской компании

  // Referral fields
  referralCode    String?   @unique @map("referral_code") // Уникальный реферальный код компании
  referredBy      String?   @map("referred_by") // ID компании, которая пригласила
  referralCodeId  String?   @map("referral_code_id") // ID реферального кода, по которому зарегистрировались

  // Relations
  parentCompany   Company?  @relation("CompanyHierarchy", fields: [parentCompanyId], references: [id], onDelete: SetNull)
  childCompanies  Company[] @relation("CompanyHierarchy")
  apiKeys         ApiKey[]
  refreshTokens   RefreshToken[]
  loginAttempts   LoginAttempt[]
  passwordResets  PasswordResetToken[]
  emailVerifications EmailVerificationToken[]
  securityEvents  SecurityEvent[]
  providerPreferences CompanyProviderPreference[]
  
  // Referral relations
  referralCodes   ReferralCode[] @relation("ReferralCodeOwner")
  referredCompanies Company[] @relation("ReferredBy")
  usedReferralCode ReferralCode? @relation("UsedReferralCode", fields: [referralCodeId], references: [id], onDelete: SetNull)
  referrer        Company?  @relation("ReferredBy", fields: [referredBy], references: [id], onDelete: SetNull)

  @@map("companies")
  @@index([parentCompanyId])
  @@index([email])
  @@index([referralCode])
  @@index([referredBy])
}


model ApiKey {
  id          String    @id @default(uuid())
  key         String    @unique
  companyId   String    @map("company_id")
  name        String
  description String?
  isActive    Boolean   @default(true) @map("is_active")
  permissions Json      @default("[]")
  lastUsedAt  DateTime? @map("last_used_at")
  expiresAt   DateTime? @map("expires_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  metadata    Json?

  // Relations
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("api_keys")
  @@index([companyId])
  @@index([key])
}

model RefreshToken {
  id        String    @id @default(uuid())
  companyId String    @map("company_id")
  token     String    @unique
  expiresAt DateTime  @map("expires_at")
  isRevoked Boolean   @default(false) @map("is_revoked")
  createdAt DateTime  @default(now()) @map("created_at")
  lastUsedAt DateTime? @map("last_used_at")
  userAgent String?   @map("user_agent")
  ipAddress String?   @map("ip_address")

  // Relations
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
  @@index([companyId])
  @@index([token])
}

model LoginAttempt {
  id           String   @id @default(uuid())
  email        String
  ipAddress    String   @map("ip_address")
  userAgent    String   @map("user_agent")
  success      Boolean
  failureReason String? @map("failure_reason")
  timestamp    DateTime @default(now())

  // Relations
  company Company? @relation(fields: [email], references: [email], map: "login_attempt_company")

  @@map("login_attempts")
  @@index([email])
  @@index([ipAddress])
  @@index([timestamp])
}

model PasswordResetToken {
  id        String    @id @default(uuid())
  companyId String    @map("company_id")
  token     String    @unique
  expiresAt DateTime  @map("expires_at")
  isUsed    Boolean   @default(false) @map("is_used")
  createdAt DateTime  @default(now()) @map("created_at")

  // Relations
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("password_reset_tokens")
  @@index([companyId])
  @@index([token])
}

model EmailVerificationToken {
  id        String    @id @default(uuid())
  companyId String    @map("company_id")
  token     String    @unique
  expiresAt DateTime  @map("expires_at")
  isUsed    Boolean   @default(false) @map("is_used")
  createdAt DateTime  @default(now()) @map("created_at")

  // Relations
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("email_verification_tokens")
  @@index([companyId])
  @@index([token])
}

model SecurityEvent {
  id          String        @id @default(uuid())
  companyId   String?       @map("company_id")
  type        SecurityEventType
  severity    SecuritySeverity
  description String
  ipAddress   String?       @map("ip_address")
  userAgent   String?       @map("user_agent")
  metadata    Json?
  timestamp   DateTime      @default(now())

  // Relations
  company Company? @relation(fields: [companyId], references: [id], onDelete: SetNull)

  @@map("security_events")
  @@index([companyId])
  @@index([type])
  @@index([timestamp])
}

enum UserRole {
  admin
  company
  service
  fsb
}

enum BillingMode {
  SELF_PAID     // Оплачивает сама
  PARENT_PAID   // Оплачивает родительская компания
}

enum SecurityEventType {
  LOGIN
  LOGOUT
  PASSWORD_CHANGE
  API_KEY_CREATED
  API_KEY_REVOKED
  SUSPICIOUS_ACTIVITY
}

enum SecuritySeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

model ReferralCode {
  id              String    @id @default(uuid())
  code            String    @unique // Уникальный код для ссылки
  companyId       String    @map("company_id") // Владелец реферального кода
  isActive        Boolean   @default(true) @map("is_active")
  maxUses         Int?      @map("max_uses") // Максимальное количество использований (null = без ограничений)
  usedCount       Int       @default(0) @map("used_count") // Количество использований
  expiresAt       DateTime? @map("expires_at") // Дата истечения (null = бессрочно)
  description     String?   // Описание кода
  metadata        Json?     // Дополнительные данные
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  owner           Company   @relation("ReferralCodeOwner", fields: [companyId], references: [id], onDelete: Cascade)
  usedBy          Company[] @relation("UsedReferralCode") // Компании, которые использовали этот код

  @@map("referral_codes")
  @@index([companyId])
  @@index([code])
  @@index([isActive])
  @@index([expiresAt])
}

model CompanyProviderPreference {
  id              String    @id @default(uuid())
  companyId       String    @map("company_id")
  model           String    // Название модели (например, "gpt-4")
  preferredProvider String  @map("preferred_provider") // Предпочитаемый провайдер (например, "openai", "openrouter")
  isActive        Boolean   @default(true) @map("is_active")
  priority        Int       @default(1) // Приоритет (1 = высший)
  fallbackProviders String[] @map("fallback_providers") // Резервные провайдеры
  costLimit       Decimal?  @map("cost_limit") @db.Decimal(10, 6) // Лимит стоимости за токен
  maxTokens       Int?      @map("max_tokens") // Максимальное количество токенов
  metadata        Json?     // Дополнительные настройки
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  company         Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("company_provider_preferences")
  @@index([companyId])
  @@index([model])
  @@index([preferredProvider])
  @@index([isActive])
  @@unique([companyId, model]) // Один предпочтение на модель для компании
}
