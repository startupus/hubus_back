# üéØ –§–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç: –ò–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫–∞—è —Å–∏—Å—Ç–µ–º–∞ –∫–æ–º–ø–∞–Ω–∏–π

## ‚úÖ –†–∞–±–æ—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –Ω–∞ 100%

---

## üìã –ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ

### 1. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è ‚úÖ

**–î–æ:**
```
User (—Å–æ—Ç—Ä—É–¥–Ω–∏–∫) ‚Üí —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ ‚Üí Company (–∫–æ–º–ø–∞–Ω–∏—è)
```

**–ü–æ—Å–ª–µ:**
```
Company –º–æ–∂–µ—Ç –±—ã—Ç—å:
  - Root (–Ω–µ–∑–∞–≤–∏—Å–∏–º–∞—è –∫–æ–º–ø–∞–Ω–∏—è)
  - Child (–¥–æ—á–µ—Ä–Ω—è—è –∫–æ–º–ø–∞–Ω–∏—è –¥—Ä—É–≥–æ–π –∫–æ–º–ø–∞–Ω–∏–∏)
  
–ö–∞–∂–¥–∞—è –∫–æ–º–ø–∞–Ω–∏—è = –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∏—Å—Ç–µ–º—ã
```

### 2. –ö–ª—é—á–µ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ ‚úÖ

#### Auth Service
- ‚úÖ –£–¥–∞–ª–µ–Ω–∞ –º–æ–¥–µ–ª—å `User`
- ‚úÖ –†–∞—Å—à–∏—Ä–µ–Ω–∞ –º–æ–¥–µ–ª—å `Company`:
  - `parentCompanyId` - —Å—Å—ã–ª–∫–∞ –Ω–∞ —Ä–æ–¥–∏—Ç–µ–ª—è
  - `billingMode` - —Ä–µ–∂–∏–º –æ–ø–ª–∞—Ç—ã (SELF_PAID | PARENT_PAID)
  - `position`, `department` - –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
- ‚úÖ –ù–æ–≤—ã–µ –º–µ—Ç–æ–¥—ã:
  - `createChildCompany()` - —Å–æ–∑–¥–∞–Ω–∏–µ –¥–æ—á–µ—Ä–Ω–µ–π –∫–æ–º–ø–∞–Ω–∏–∏
  - `getCompanyHierarchy()` - –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–µ—Ä–µ–≤–∞
  - `updateCompanyBillingMode()` - –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞

#### Billing Service
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ `initiatorCompanyId` –≤:
  - `Transaction` - –∫—Ç–æ –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞–ª —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
  - `UsageEvent` - –∫—Ç–æ —Å–¥–µ–ª–∞–ª –∑–∞–ø—Ä–æ—Å
- ‚úÖ –ù–æ–≤—ã–π –º–µ—Ç–æ–¥ `determinePayerCompany()`:
  - –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∫—Ç–æ –ø–ª–∞—Ç–∏—Ç (—Ä–æ–¥–∏—Ç–µ–ª—å –∏–ª–∏ —Å–∞–º–∞ –∫–æ–º–ø–∞–Ω–∏—è)
  - **–°–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–ª—å–∫–æ –Ω–∞ 1 —É—Ä–æ–≤–µ–Ω—å –≤–≤–µ—Ä—Ö!**
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω `trackUsage()` - —É—á–∏—Ç—ã–≤–∞–µ—Ç billing mode

#### API Gateway
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω—ã endpoints –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å `companyId` –≤–º–µ—Å—Ç–æ `userId`
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã endpoints –¥–ª—è "–º–æ–µ–≥–æ –±–∞–ª–∞–Ω—Å–∞", "–º–æ–∏—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π"

### 3. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö ‚úÖ

**–ú–∏–≥—Ä–∞—Ü–∏–∏ —Å–æ–∑–¥–∞–Ω—ã:**
- `migrations/001_add_company_hierarchy_auth.sql` - Auth Service
- `migrations/002_add_company_hierarchy_billing.sql` - Billing Service

**–°–∫—Ä–∏–ø—Ç –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è:**
- `apply-hierarchy-migrations.ps1` - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π

### 4. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è ‚úÖ

–°–æ–∑–¥–∞–Ω–æ 4 —Ñ–∞–π–ª–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏:

1. **HIERARCHICAL_SYSTEM_IMPLEMENTATION.md** - –ø–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
2. **DEPLOYMENT_GUIDE_HIERARCHICAL.md** - —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—é
3. **HIERARCHICAL_COMPANIES_ARCHITECTURE.md** - –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π –¥–∏–∑–∞–π–Ω
4. **IMPLEMENTATION_COMPLETE_REPORT.md** - –æ—Ç—á–µ—Ç –æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏

### 5. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ ‚úÖ

**–°–æ–∑–¥–∞–Ω —Å–∫—Ä–∏–ø—Ç:** `test-hierarchical-system.ps1`

–ü—Ä–æ–≤–µ—Ä—è–µ—Ç:
- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é root-–∫–æ–º–ø–∞–Ω–∏–∏
- –°–æ–∑–¥–∞–Ω–∏–µ –¥–æ—á–µ—Ä–Ω–∏—Ö –∫–æ–º–ø–∞–Ω–∏–π
- –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–µ—Ä–∞—Ä—Ö–∏–∏
- AI-–∑–∞–ø—Ä–æ—Å—ã —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –±–∏–ª–ª–∏–Ω–≥–æ–º
- –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞ –æ–ø–ª–∞—Ç—ã

---

## üéì –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞—Å–∫–∞–¥–Ω–æ–µ —Å–ø–∏—Å–∞–Ω–∏–µ

### –ü—Ä–∞–≤–∏–ª–æ: –°–ø–∏—Å–∞–Ω–∏–µ –¢–û–õ–¨–ö–û –Ω–∞ 1 —É—Ä–æ–≤–µ–Ω—å –≤–≤–µ—Ä—Ö

```
Company A (root, SELF_PAID, –±–∞–ª–∞–Ω—Å: $1000)
  ‚îî‚îÄ Company B (PARENT_PAID, –±–∞–ª–∞–Ω—Å: $0)
       ‚îî‚îÄ Company C (PARENT_PAID, –±–∞–ª–∞–Ω—Å: $0)
```

**–°—Ü–µ–Ω–∞—Ä–∏–∏:**

1. **Company A** –¥–µ–ª–∞–µ—Ç –∑–∞–ø—Ä–æ—Å ‚Üí —Å–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è —Å **A** ‚úÖ
2. **Company B** –¥–µ–ª–∞–µ—Ç –∑–∞–ø—Ä–æ—Å ‚Üí —Å–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è —Å **A** (–µ—ë —Ä–æ–¥–∏—Ç–µ–ª—è) ‚úÖ
3. **Company C** –¥–µ–ª–∞–µ—Ç –∑–∞–ø—Ä–æ—Å ‚Üí —Å–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è —Å **B** (–µ—ë —Ä–æ–¥–∏—Ç–µ–ª—è) ‚úÖ

**–ù–ï —Å–æ:** Company A! (–Ω–µ —Å–∫–≤–æ–∑–Ω–æ–µ —Å–ø–∏—Å–∞–Ω–∏–µ)

### –ï—Å–ª–∏ Company C —Ö–æ—á–µ—Ç —á—Ç–æ–±—ã –ø–ª–∞—Ç–∏–ª–∞ Company A:

```
–í–∞—Ä–∏–∞–Ω—Ç 1: –ü–æ–º–µ–Ω—è—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É
Company A
  ‚îú‚îÄ Company B
  ‚îî‚îÄ Company C (PARENT_PAID) ‚Üí —Ç–µ–ø–µ—Ä—å —Å–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è —Å A

–í–∞—Ä–∏–∞–Ω—Ç 2: Company C –ø–ª–∞—Ç–∏—Ç —Å–∞–º–∞
Company C (billingMode = SELF_PAID, –±–∞–ª–∞–Ω—Å: $500)
```

---

## üìö API Endpoints

### Company Management

```bash
# –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è root-–∫–æ–º–ø–∞–Ω–∏–∏
POST /companies/register
{
  "name": "My Company",
  "email": "company@example.com",
  "password": "SecurePass123!"
}

# –°–æ–∑–¥–∞—Ç—å –¥–æ—á–µ—Ä–Ω—é—é –∫–æ–º–ø–∞–Ω–∏—é
POST /companies/{parentId}/child-companies
Authorization: Bearer {token}
{
  "name": "Child Company",
  "email": "child@example.com",
  "password": "ChildPass123!",
  "billingMode": "PARENT_PAID"  # –∏–ª–∏ "SELF_PAID"
}

# –ü–æ–ª—É—á–∏—Ç—å –∏–µ—Ä–∞—Ä—Ö–∏—é
GET /companies/{companyId}/hierarchy?depth=3

# –ò–∑–º–µ–Ω–∏—Ç—å —Ä–µ–∂–∏–º –±–∏–ª–ª–∏–Ω–≥–∞
PUT /companies/{companyId}/billing-mode
{
  "billingMode": "SELF_PAID"
}
```

### Billing

```bash
# –ú–æ–π –±–∞–ª–∞–Ω—Å
GET /v1/billing/balance
Authorization: Bearer {token}

# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–æ—á–µ—Ä–Ω–∏—Ö –∫–æ–º–ø–∞–Ω–∏–π
GET /billing/company/{companyId}/users/statistics
```

---

## üöÄ –ö–∞–∫ –∑–∞–ø—É—Å—Ç–∏—Ç—å

### –®–∞–≥ 1: –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏

```powershell
.\apply-hierarchy-migrations.ps1
```

### –®–∞–≥ 2: –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å —Å–µ—Ä–≤–∏—Å—ã

```powershell
docker-compose build auth-service billing-service api-gateway
```

### –®–∞–≥ 3: –ó–∞–ø—É—Å—Ç–∏—Ç—å

```powershell
docker-compose up -d
```

### –®–∞–≥ 4: –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å

```powershell
.\test-hierarchical-system.ps1
```

---

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –ò–∑–º–µ–Ω–µ–Ω–∏—è |
|-----------|-----------|
| **–°—Ö–µ–º—ã –ë–î** | 2 —Ñ–∞–π–ª–∞ –æ–±–Ω–æ–≤–ª–µ–Ω—ã (auth, billing) |
| **–°–µ—Ä–≤–∏—Å—ã** | 4 —Ñ–∞–π–ª–∞ –æ–±–Ω–æ–≤–ª–µ–Ω—ã (CompanyService, BillingService, CompanyController, BillingController) |
| **–ú–∏–≥—Ä–∞—Ü–∏–∏** | 2 SQL —Ñ–∞–π–ª–∞ + 1 PowerShell —Å–∫—Ä–∏–ø—Ç |
| **–¢–µ—Å—Ç—ã** | 1 –∫–æ–º–ø–ª–µ–∫—Å–Ω—ã–π —Ç–µ—Å—Ç-—Å–∫—Ä–∏–ø—Ç |
| **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è** | 5 MD —Ñ–∞–π–ª–æ–≤ (–≤–∫–ª—é—á–∞—è —ç—Ç–æ—Ç) |

---

## ‚ú® –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã

1. **–ü—Ä–æ—Å—Ç–æ—Ç–∞:** –ù–µ—Ç —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è User/Company - –≤—Å–µ –∫–æ–º–ø–∞–Ω–∏–∏
2. **–ì–∏–±–∫–æ—Å—Ç—å:** –ù–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–∞—è –≥–ª—É–±–∏–Ω–∞ –∏–µ—Ä–∞—Ä—Ö–∏–∏
3. **–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å:** –í–∏–¥–Ω–æ –∫—Ç–æ –ø–ª–∞—Ç–∏—Ç –∏ –∫—Ç–æ –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞–ª
4. **–ö–æ–Ω—Ç—Ä–æ–ª—å:** –ö–∞–∂–¥–∞—è –∫–æ–º–ø–∞–Ω–∏—è –≤—ã–±–∏—Ä–∞–µ—Ç —Ä–µ–∂–∏–º –æ–ø–ª–∞—Ç—ã
5. **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å:** –õ–µ–≥–∫–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ —É—Ä–æ–≤–Ω–∏

---

## üî• –ß—Ç–æ –¥–∞–ª—å—à–µ?

–°–∏—Å—Ç–µ–º–∞ **–ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!**

–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è –Ω–∞ –±—É–¥—É—â–µ–µ:
- –õ–∏–º–∏—Ç—ã –¥–ª—è –¥–æ—á–µ—Ä–Ω–∏—Ö –∫–æ–º–ø–∞–Ω–∏–π
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–∏–∑–∫–æ–º –±–∞–ª–∞–Ω—Å–µ
- –î–µ—Ç–∞–ª—å–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ
- –≠–∫—Å–ø–æ—Ä—Ç –æ—Ç—á–µ—Ç–æ–≤ –≤ PDF/Excel

---

## üìù –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º

- [x] –°—Ö–µ–º—ã –ë–î –æ–±–Ω–æ–≤–ª–µ–Ω—ã
- [x] –°–µ—Ä–≤–∏—Å—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã
- [x] –ú–∏–≥—Ä–∞—Ü–∏–∏ —Å–æ–∑–¥–∞–Ω—ã
- [x] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –Ω–∞–ø–∏—Å–∞–Ω–∞
- [x] –¢–µ—Å—Ç—ã —Å–æ–∑–¥–∞–Ω—ã
- [ ] –ú–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã (–≤—ã–ø–æ–ª–Ω–∏—Ç—å: `.\apply-hierarchy-migrations.ps1`)
- [ ] –°–µ—Ä–≤–∏—Å—ã –ø–µ—Ä–µ—Å–æ–±—Ä–∞–Ω—ã (–≤—ã–ø–æ–ª–Ω–∏—Ç—å: `docker-compose build`)
- [ ] –°–∏—Å—Ç–µ–º–∞ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∞ (–≤—ã–ø–æ–ª–Ω–∏—Ç—å: `.\test-hierarchical-system.ps1`)

---

## üéâ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

**–í—Å—è —Ä–∞–±–æ—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!**

–°–∏—Å—Ç–µ–º–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∞–Ω–∞ —Å–æ–≥–ª–∞—Å–Ω–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º:
- ‚úÖ –ë–æ–ª—å—à–µ –Ω–µ—Ç –æ–±—ã—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- ‚úÖ –ö–∞–∂–¥—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - –∫–æ–º–ø–∞–Ω–∏—è
- ‚úÖ –ö–æ–º–ø–∞–Ω–∏–∏ –º–æ–≥—É—Ç –∏–º–µ—Ç—å –¥–æ—á–µ—Ä–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏
- ‚úÖ –ö–∞—Å–∫–∞–¥–Ω–æ–µ —Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ 1 —É—Ä–æ–≤–µ–Ω—å –≤–≤–µ—Ä—Ö
- ‚úÖ –ì–∏–±–∫–∏–µ —Ä–µ–∂–∏–º—ã –æ–ø–ª–∞—Ç—ã (SELF_PAID / PARENT_PAID)

**–í—Ä–µ–º—è –ø—Ä–∏—Å—Ç—É–ø–∏—Ç—å –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é! üöÄ**

```powershell
# –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ –≤ 4 –∫–æ–º–∞–Ω–¥—ã:
.\apply-hierarchy-migrations.ps1
docker-compose build auth-service billing-service
docker-compose up -d
.\test-hierarchical-system.ps1
```

