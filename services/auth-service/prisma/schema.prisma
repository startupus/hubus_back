// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("AUTH_DATABASE_URL")
}

model Company {
  id              String    @id @default(uuid())
  name            String
  email           String    @unique
  passwordHash    String    @map("password_hash")
  isActive        Boolean   @default(true) @map("is_active")
  isVerified      Boolean   @default(false) @map("is_verified")
  role            UserRole  @default(company)
  description     String?
  website         String?
  phone           String?
  address         Json?
  settings        Json?
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  lastLoginAt     DateTime? @map("last_login_at")
  metadata        Json?

  // Hierarchy fields
  parentCompanyId String?   @map("parent_company_id")
  billingMode     BillingMode @default(SELF_PAID) @map("billing_mode") // SELF_PAID или PARENT_PAID
  position        String?   // Должность в родительской компании
  department      String?   // Отдел в родительской компании

  // Relations
  parentCompany   Company?  @relation("CompanyHierarchy", fields: [parentCompanyId], references: [id], onDelete: SetNull)
  childCompanies  Company[] @relation("CompanyHierarchy")
  apiKeys         ApiKey[]
  refreshTokens   RefreshToken[]
  loginAttempts   LoginAttempt[]
  passwordResets  PasswordResetToken[]
  emailVerifications EmailVerificationToken[]
  securityEvents  SecurityEvent[]

  @@map("companies")
  @@index([parentCompanyId])
  @@index([email])
}


model ApiKey {
  id          String    @id @default(uuid())
  key         String    @unique
  companyId   String    @map("company_id")
  name        String
  description String?
  isActive    Boolean   @default(true) @map("is_active")
  permissions Json      @default("[]")
  lastUsedAt  DateTime? @map("last_used_at")
  expiresAt   DateTime? @map("expires_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  metadata    Json?

  // Relations
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("api_keys")
  @@index([companyId])
  @@index([key])
}

model RefreshToken {
  id        String    @id @default(uuid())
  companyId String    @map("company_id")
  token     String    @unique
  expiresAt DateTime  @map("expires_at")
  isRevoked Boolean   @default(false) @map("is_revoked")
  createdAt DateTime  @default(now()) @map("created_at")
  lastUsedAt DateTime? @map("last_used_at")
  userAgent String?   @map("user_agent")
  ipAddress String?   @map("ip_address")

  // Relations
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
  @@index([companyId])
  @@index([token])
}

model LoginAttempt {
  id           String   @id @default(uuid())
  email        String
  ipAddress    String   @map("ip_address")
  userAgent    String   @map("user_agent")
  success      Boolean
  failureReason String? @map("failure_reason")
  timestamp    DateTime @default(now())

  // Relations
  company Company? @relation(fields: [email], references: [email], map: "login_attempt_company")

  @@map("login_attempts")
  @@index([email])
  @@index([ipAddress])
  @@index([timestamp])
}

model PasswordResetToken {
  id        String    @id @default(uuid())
  companyId String    @map("company_id")
  token     String    @unique
  expiresAt DateTime  @map("expires_at")
  isUsed    Boolean   @default(false) @map("is_used")
  createdAt DateTime  @default(now()) @map("created_at")

  // Relations
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("password_reset_tokens")
  @@index([companyId])
  @@index([token])
}

model EmailVerificationToken {
  id        String    @id @default(uuid())
  companyId String    @map("company_id")
  token     String    @unique
  expiresAt DateTime  @map("expires_at")
  isUsed    Boolean   @default(false) @map("is_used")
  createdAt DateTime  @default(now()) @map("created_at")

  // Relations
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("email_verification_tokens")
  @@index([companyId])
  @@index([token])
}

model SecurityEvent {
  id          String        @id @default(uuid())
  companyId   String?       @map("company_id")
  type        SecurityEventType
  severity    SecuritySeverity
  description String
  ipAddress   String?       @map("ip_address")
  userAgent   String?       @map("user_agent")
  metadata    Json?
  timestamp   DateTime      @default(now())

  // Relations
  company Company? @relation(fields: [companyId], references: [id], onDelete: SetNull)

  @@map("security_events")
  @@index([companyId])
  @@index([type])
  @@index([timestamp])
}

enum UserRole {
  admin
  company
  service
  fsb
}

enum BillingMode {
  SELF_PAID     // Оплачивает сама
  PARENT_PAID   // Оплачивает родительская компания
}

enum SecurityEventType {
  LOGIN
  LOGOUT
  PASSWORD_CHANGE
  API_KEY_CREATED
  API_KEY_REVOKED
  SUSPICIOUS_ACTIVITY
}

enum SecuritySeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}
