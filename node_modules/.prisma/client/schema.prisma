// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("AUTH_DATABASE_URL")
}

model User {
  id           String    @id @default(uuid())
  email        String    @unique
  passwordHash String    @map("password_hash")
  isActive     Boolean   @default(true) @map("is_active")
  isVerified   Boolean   @default(false) @map("is_verified")
  role         UserRole  @default(user)
  firstName    String?   @map("first_name")
  lastName     String?   @map("last_name")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  lastLoginAt  DateTime? @map("last_login_at")
  metadata     Json?

  // Relations
  apiKeys            ApiKey[]
  refreshTokens      RefreshToken[]
  loginAttempts      LoginAttempt[]
  passwordResets     PasswordResetToken[]
  emailVerifications EmailVerificationToken[]
  securityEvents     SecurityEvent[]

  @@map("users")
}

model ApiKey {
  id          String    @id @default(uuid())
  key         String    @unique
  userId      String    @map("user_id")
  name        String
  description String?
  isActive    Boolean   @default(true) @map("is_active")
  permissions Json      @default("[]")
  lastUsedAt  DateTime? @map("last_used_at")
  expiresAt   DateTime? @map("expires_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  metadata    Json?

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([key])
  @@map("api_keys")
}

model RefreshToken {
  id         String    @id @default(uuid())
  userId     String    @map("user_id")
  token      String    @unique
  expiresAt  DateTime  @map("expires_at")
  isRevoked  Boolean   @default(false) @map("is_revoked")
  createdAt  DateTime  @default(now()) @map("created_at")
  lastUsedAt DateTime? @map("last_used_at")
  userAgent  String?   @map("user_agent")
  ipAddress  String?   @map("ip_address")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

model LoginAttempt {
  id            String   @id @default(uuid())
  email         String
  ipAddress     String   @map("ip_address")
  userAgent     String   @map("user_agent")
  success       Boolean
  failureReason String?  @map("failure_reason")
  timestamp     DateTime @default(now())

  // Relations
  user User? @relation(fields: [email], references: [email])

  @@index([email])
  @@index([ipAddress])
  @@index([timestamp])
  @@map("login_attempts")
}

model PasswordResetToken {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  isUsed    Boolean  @default(false) @map("is_used")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("password_reset_tokens")
}

model EmailVerificationToken {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  isUsed    Boolean  @default(false) @map("is_used")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("email_verification_tokens")
}

model SecurityEvent {
  id          String            @id @default(uuid())
  userId      String?           @map("user_id")
  type        SecurityEventType
  severity    SecuritySeverity
  description String
  ipAddress   String?           @map("ip_address")
  userAgent   String?           @map("user_agent")
  metadata    Json?
  timestamp   DateTime          @default(now())

  // Relations
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([type])
  @@index([timestamp])
  @@map("security_events")
}

enum UserRole {
  admin
  user
  service
}

enum SecurityEventType {
  LOGIN
  LOGOUT
  PASSWORD_CHANGE
  API_KEY_CREATED
  API_KEY_REVOKED
  SUSPICIOUS_ACTIVITY
}

enum SecuritySeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}
