# –†–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π Payment Service - –§–∏–Ω–∞–ª—å–Ω—ã–π –û—Ç—á–µ—Ç

## üéØ –¶–µ–ª—å
–°–æ–∑–¥–∞—Ç—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—É—é –∑–∞–≥–ª—É—à–∫—É payment-service —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö –∏ –ø–æ–ª–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å—é, –∫–æ—Ç–æ—Ä–∞—è –ª–µ–≥–∫–æ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è –Ω–∞ —Ä–µ–∞–ª—å–Ω—É—é –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é.

## ‚úÖ –ß—Ç–æ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

### 1. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
- **–†–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π PaymentService** —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏ fallback –Ω–∞ in-memory
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –ë–î** - –µ—Å–ª–∏ –ë–î –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞, —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ —Ä–µ–∂–∏–º–µ –∑–∞–≥–ª—É—à–∫–∏
- **–ü–æ–ª–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Prisma** –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å PostgreSQL
- **–†–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–µ –º–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö** —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ —Ç–∏–ø–∞–º–∏ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π

### 2. –û—Å–Ω–æ–≤–Ω—ã–µ –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

#### RealisticPaymentService
- ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–µ–π —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π (–º–∏–Ω. 100 RUB, –º–∞–∫—Å. 1,000,000 RUB)
- ‚úÖ –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–µ–π –ø–æ ID —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–Ω–æ—Å—Ç–∏ –∫–æ–º–ø–∞–Ω–∏–∏
- ‚úÖ –°–ø–∏—Å–æ–∫ –ø–ª–∞—Ç–µ–∂–µ–π –∫–æ–º–ø–∞–Ω–∏–∏ —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π
- ‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π (–æ–±—â–∞—è —Å—É–º–º–∞, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ, —É—Å–ø–µ—à–Ω–æ—Å—Ç—å)
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ webhook'–æ–≤ –æ—Ç YooKassa
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π fallback –Ω–∞ in-memory storage –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –ë–î

#### RealisticYooKassaService
- ‚úÖ –†–µ–∞–ª–∏—Å—Ç–∏—á–Ω–∞—è –∑–∞–≥–ª—É—à–∫–∞ YooKassa API
- ‚úÖ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã—Ö payment ID
- ‚úÖ –†–∞—Å—á–µ—Ç –∫–æ–º–∏—Å—Å–∏–∏ (2.9% + 15 —Ä—É–±)
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∫—É—Ä—Å–æ–≤ –≤–∞–ª—é—Ç (–∑–∞–≥–ª—É—à–∫–∞ –¥–ª—è USD/RUB)
- ‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –º–∞–≥–∞–∑–∏–Ω–∞ –∏ –ª–∏–º–∏—Ç—ã

#### RealisticWebhookController
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ webhook'–æ–≤ –æ—Ç YooKassa
- ‚úÖ –¢–µ—Å—Ç–æ–≤—ã–π webhook –¥–ª—è –∏–º–∏—Ç–∞—Ü–∏–∏ –ø–ª–∞—Ç–µ–∂–µ–π
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∏ (–∑–∞–≥–ª—É—à–∫–∞)

### 3. –ë–∞–∑–∞ –î–∞–Ω–Ω—ã—Ö
- ‚úÖ **Prisma —Å—Ö–µ–º–∞** —Å –º–æ–¥–µ–ª—å—é Payment
- ‚úÖ **–ú–∏–≥—Ä–∞—Ü–∏–∏** –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü
- ‚úÖ **–ò–Ω–¥–µ–∫—Å—ã** –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤
- ‚úÖ **–ü–æ–¥–¥–µ—Ä–∂–∫–∞ Decimal** –¥–ª—è —Ç–æ—á–Ω—ã—Ö —Ä–∞—Å—á–µ—Ç–æ–≤

### 4. API Endpoints
```
POST /api/v1/payments              - –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞
GET  /api/v1/payments              - –°–ø–∏—Å–æ–∫ –ø–ª–∞—Ç–µ–∂–µ–π –∫–æ–º–ø–∞–Ω–∏–∏
GET  /api/v1/payments/:id          - –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞ –ø–æ ID
GET  /api/v1/payments/stats/summary - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π
POST /api/v1/webhooks/yookassa     - Webhook –æ—Ç YooKassa
POST /api/v1/webhooks/test         - –¢–µ—Å—Ç–æ–≤—ã–π webhook
GET  /api/v1/health                - Health check
```

## üß™ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### ‚úÖ –£—Å–ø–µ—à–Ω—ã–µ –¢–µ—Å—Ç—ã
1. **–°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–µ–π** - —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
2. **–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π** - —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π
3. **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π** - –ø–æ–¥—Å—á–µ—Ç —Å—É–º–º –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
4. **Webhook –æ–±—Ä–∞–±–æ—Ç–∫–∞** - –∏–º–∏—Ç–∞—Ü–∏—è —É—Å–ø–µ—à–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π
5. **JWT –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è** - –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–æ–≤
6. **Fallback –Ω–∞ in-memory** - –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –ë–î

### üìä –ü—Ä–∏–º–µ—Ä—ã –î–∞–Ω–Ω—ã—Ö
```json
// –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞
{
  "amount": 5000,
  "currency": "RUB",
  "description": "Balance top-up for testing"
}

// –û—Ç–≤–µ—Ç
{
  "id": "yk_1760139881805_aqw5chec6",
  "status": "pending",
  "confirmationUrl": "https://yookassa.ru/payment/yk_1760139881805_aqw5chec6",
  "amount": "5000",
  "currency": "RUB",
  "description": "Balance top-up for testing",
  "createdAt": "2025-10-10T23:44:41.805Z",
  "paidAt": null
}

// –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
{
  "totalAmount": 3500,
  "totalCount": 2,
  "successfulCount": 0,
  "successRate": 0
}
```

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

### 1. –£–º–Ω—ã–π Fallback
```typescript
// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –ë–î
private async checkDatabaseAvailability() {
  try {
    await this.prisma.$queryRaw`SELECT 1`;
    this.isDatabaseAvailable = true;
  } catch (error) {
    this.isDatabaseAvailable = false;
    // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ in-memory storage
  }
}
```

### 2. –†–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–µ ID –∏ URL
```typescript
// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã—Ö payment ID
private generatePaymentId(): string {
  const timestamp = Date.now();
  const random = Math.random().toString(36).substr(2, 9);
  return `yk_${timestamp}_${random}`;
}
```

### 3. –†–∞—Å—á–µ—Ç –ö–æ–º–∏—Å—Å–∏–∏
```typescript
// –ö–æ–º–∏—Å—Å–∏—è –ÆKassa: 2.9% + 15 —Ä—É–±
private calculateCommission(amount: number): Decimal {
  const percentage = new Decimal(0.029);
  const fixed = new Decimal(15);
  return new Decimal(amount).mul(percentage).add(fixed);
}
```

## üöÄ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ –†–µ–∞–ª—å–Ω—É—é –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é

### –ß—Ç–æ –ù—É–∂–Ω–æ –ò–∑–º–µ–Ω–∏—Ç—å
1. **YooKassaService** - –∑–∞–º–µ–Ω–∏—Ç—å –∑–∞–≥–ª—É—à–∫–∏ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ API –≤—ã–∑–æ–≤—ã
2. **Webhook –≤–∞–ª–∏–¥–∞—Ü–∏—è** - —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –ø–æ–¥–ø–∏—Å–∏
3. **–ö—É—Ä—Å—ã –≤–∞–ª—é—Ç** - –ø–æ–¥–∫–ª—é—á–∏—Ç—å API –¶–ë –†–§
4. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å billing-service** - –¥–æ–±–∞–≤–∏—Ç—å HTTP –≤—ã–∑–æ–≤—ã –¥–ª—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞

### –ü—Ä–∏–º–µ—Ä –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è
```typescript
// –í–º–µ—Å—Ç–æ –∑–∞–≥–ª—É—à–∫–∏
return this.createStubPayment(paymentId, data);

// –†–µ–∞–ª—å–Ω—ã–π –≤—ã–∑–æ–≤
return await this.yooKassaClient.createPayment({
  amount: { value: data.amount.toFixed(2), currency: data.currency },
  confirmation: { type: 'redirect', return_url: data.returnUrl },
  description: data.description,
  metadata: { companyId: data.companyId }
});
```

## üìà –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –†–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ–π –ó–∞–≥–ª—É—à–∫–∏

1. **–ü–æ–ª–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å** —Å —Ä–µ–∞–ª—å–Ω—ã–º API
2. **–õ–µ–≥–∫–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ** –Ω–∞ —Ä–µ–∞–ª—å–Ω—É—é –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é
3. **–†–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ** –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
4. **–û—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å** - —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–∞–∂–µ –±–µ–∑ –ë–î
5. **–ü–æ–ª–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å** - –≤—Å–µ endpoints —Ä–∞–±–æ—Ç–∞—é—Ç
6. **–ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è** –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

## üéâ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–†–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π payment-service –ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤ –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω. –û–Ω –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç:
- ‚úÖ –ü–æ–ª–Ω—É—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã
- ‚úÖ –†–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏ –ø–æ–≤–µ–¥–µ–Ω–∏–µ
- ‚úÖ –û—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –∏ fallback –º–µ—Ö–∞–Ω–∏–∑–º—ã
- ‚úÖ –õ–µ–≥–∫–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ —Ä–µ–∞–ª—å–Ω—É—é –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é
- ‚úÖ –ü–æ–ª–Ω—É—é —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π

–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ production –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –≤ —Ä–µ–∂–∏–º–µ –∑–∞–≥–ª—É—à–∫–∏ –∏ –ª–µ–≥–∫–æ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è –Ω–∞ —Ä–µ–∞–ª—å–Ω—É—é –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å YooKassa –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏.

## üìù –°—Ç–∞—Ç—É—Å: ‚úÖ –ó–ê–í–ï–†–®–ï–ù–û
**–î–∞—Ç–∞:** 10 –æ–∫—Ç—è–±—Ä—è 2025  
**–í–µ—Ä—Å–∏—è:** 1.0.0  
**–°—Ç–∞—Ç—É—Å:** –ì–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é
