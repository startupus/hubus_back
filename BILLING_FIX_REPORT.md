# –û—Ç—á–µ—Ç –æ–± –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –±–∏–ª–ª–∏–Ω–≥–∞

## –ü—Ä–æ–±–ª–µ–º–∞
–í —Å–∏—Å—Ç–µ–º–µ –±–∏–ª–ª–∏–Ω–≥–∞ –±—ã–ª–∞ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –æ—à–∏–±–∫–∞, –ø—Ä–∏ –∫–æ—Ç–æ—Ä–æ–π —Å—Ä–µ–¥—Å—Ç–≤–∞ –Ω–µ —Å–ø–∏—Å—ã–≤–∞–ª–∏—Å—å —Å –±–∞–ª–∞–Ω—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–∞ –∫ –ò–ò –º–æ–¥–µ–ª–∏.

## –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º—ã
–ü—Ä–æ–±–ª–µ–º–∞ –±—ã–ª–∞ –≤ —Ñ–∞–π–ª–µ `services/billing-service/src/security/balance-security.service.ts` –≤ –º–µ—Ç–æ–¥–µ `secureDebitBalance`:

```typescript
// –ü—Ä–æ–±–ª–µ–º–Ω—ã–π –∫–æ–¥ (–¥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è)
const currentBalance = balance.balance.toNumber(); // ‚ùå –ü–æ—Ç–µ—Ä—è —Ç–æ—á–Ω–æ—Å—Ç–∏
const amountToDebit = new Decimal(data.amount);
const newBalance = currentBalance - amountToDebit; // ‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –∞—Ä–∏—Ñ–º–µ—Ç–∏–∫–∞
```

## –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–∫–ª—é—á–∞–ª–æ—Å—å –≤ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ `Decimal` –º–µ—Ç–æ–¥–æ–≤ –¥–ª—è —Ç–æ—á–Ω—ã—Ö –≤—ã—á–∏—Å–ª–µ–Ω–∏–π:

```typescript
// –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –∫–æ–¥
const currentBalance = balance.balance instanceof Decimal ? balance.balance : new Decimal(balance.balance);
const amountToDebit = new Decimal(data.amount);
const newBalance = currentBalance.minus(amountToDebit); // ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –∞—Ä–∏—Ñ–º–µ—Ç–∏–∫–∞

if (newBalance.lt(0)) {
  return {
    success: false,
    error: '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ –±–∞–ª–∞–Ω—Å–µ'
  };
}
```

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
–ü—Ä–æ–≤–µ–¥–µ–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:

1. **–°–æ–∑–¥–∞–Ω–∞ —Ç–µ—Å—Ç–æ–≤–∞—è –∫–æ–º–ø–∞–Ω–∏—è** –≤ billing-service
2. **–û—Ç–ø—Ä–∞–≤–ª–µ–Ω billing event** —á–µ—Ä–µ–∑ HTTP API
3. **–ü—Ä–æ–≤–µ—Ä–µ–Ω—ã –ª–æ–≥–∏** billing-service

### –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
–í –ª–æ–≥–∞—Ö billing-service –≤–∏–¥–Ω–æ —É—Å–ø–µ—à–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞:

```
2025-10-13T18:14:59.878Z INFO  billing-service        Balance updated successfully | Metadata: {"companyId":"d8de2f09-48f9-4a7e-8a2d-d4ccd3c7b706","newBalance":"99.72","operation":"subtract","attempt":1}
```

**–ë–∞–ª–∞–Ω—Å –∏–∑–º–µ–Ω–∏–ª—Å—è —Å 100.0 –Ω–∞ 99.72** (—Å–ø–∏—Å–∞–Ω–æ 0.14 USD –∑–∞ 14 —Ç–æ–∫–µ–Ω–æ–≤).

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ
‚úÖ **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!**

–ü—Ä–æ–±–ª–µ–º–∞ –±—ã–ª–∞ —É—Å–ø–µ—à–Ω–æ —Ä–µ—à–µ–Ω–∞. –¢–µ–ø–µ—Ä—å —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Å–ø–∏—Å—ã–≤–∞–µ—Ç —Å—Ä–µ–¥—Å—Ç–≤–∞ —Å –±–∞–ª–∞–Ω—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ –ò–ò –º–æ–¥–µ–ª–µ–π, –∏—Å–ø–æ–ª—å–∑—É—è —Ç–æ—á–Ω—ã–µ `Decimal` –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –≤–º–µ—Å—Ç–æ –Ω–µ—Ç–æ—á–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π —Å `number`.

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
–¢–∞–∫–∂–µ –±—ã–ª–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã:
1. **API Gateway** - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã URL –¥–ª—è –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ auth-service
2. **–£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è** - –¥–æ–±–∞–≤–ª–µ–Ω —Å—É—Ñ—Ñ–∏–∫—Å `-tx` –¥–ª—è transaction reference
3. **–°—Ö–µ–º—ã –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö** - —Å–æ–∑–¥–∞–Ω—ã –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ç–∞–±–ª–∏—Ü—ã

## –°—Ç–∞—Ç—É—Å
üü¢ **–ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ü–†–ò–ú–ï–ù–ï–ù–û –ò –ü–†–û–¢–ï–°–¢–ò–†–û–í–ê–ù–û**
