// This is your Prisma schema file for Billing Service
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("BILLING_DATABASE_URL")
}

// ===========================================
// CORE BILLING MODELS
// ===========================================

model Company {
  id                String    @id @default(uuid())
  name              String
  email             String    @unique
  isActive          Boolean   @default(true) @map("is_active")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")
  
  // Hierarchy fields
  parentCompanyId   String?   @map("parent_company_id")
  billingMode       BillingMode @default(SELF_PAID) @map("billing_mode")
  position          String?
  department        String?
  
  // Referral fields
  referralCode      String?   @unique @map("referral_code") // Уникальный реферальный код компании
  referredBy        String?   @map("referred_by") // ID компании, которая пригласила
  referralCodeId    String?   @map("referral_code_id") // ID реферального кода, по которому зарегистрировались
  
  // Relations
  parentCompany     Company?  @relation("CompanyHierarchy", fields: [parentCompanyId], references: [id], onDelete: SetNull)
  childCompanies    Company[] @relation("CompanyHierarchy")
  
  // Referral relations
  referredCompanies Company[] @relation("ReferredBy")
  referrerCompany   Company?  @relation("ReferredBy", fields: [referredBy], references: [id], onDelete: SetNull)
  
  // Billing relations
  balance           CompanyBalance?
  transactions      Transaction[]
  initiatedTransactions Transaction[] @relation("InitiatedBy")
  usageEvents       UsageEvent[]
  initiatedUsageEvents UsageEvent[] @relation("InitiatedBy")
  invoices          Invoice[]
  subscriptions     Subscription[]
  paymentMethods    PaymentMethod[]
  discountRules     DiscountRule[]
  
  // Referral billing relations
  referralTransactions ReferralTransaction[] @relation("ReferralOwner")
  earnedReferralTransactions ReferralTransaction[] @relation("ReferralEarner")
  
  @@map("companies")
  @@index([parentCompanyId])
  @@index([email])
  @@index([referralCode])
  @@index([referredBy])
}


model CompanyBalance {
  id                String    @id @default(uuid())
  companyId         String    @unique @map("company_id")
  balance           Decimal   @default(0) @db.Decimal(10, 4)
  currency          String    @default("USD")
  creditLimit       Decimal?  @map("credit_limit") @db.Decimal(10, 2)
  lastUpdated       DateTime  @default(now()) @map("last_updated")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")
  
  // Relations
  company           Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  @@map("company_balances")
}

model Transaction {
  id                String            @id @default(uuid())
  companyId         String            @map("company_id") // Компания с которой списывается
  initiatorCompanyId String?          @map("initiator_company_id") // Компания которая инициировала запрос
  type              TransactionType
  amount            Decimal           @db.Decimal(10, 4)
  currency          String            @default("USD")
  description       String?
  status            TransactionStatus @default(PENDING)
  reference         String?           @unique
  metadata          Json?
  processedAt       DateTime?         @map("processed_at")
  createdAt         DateTime          @default(now()) @map("created_at")
  updatedAt         DateTime          @updatedAt @map("updated_at")
  
  // Relations
  company           Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  initiatorCompany  Company?          @relation("InitiatedBy", fields: [initiatorCompanyId], references: [id], onDelete: SetNull)
  invoice           Invoice?          @relation(fields: [invoiceId], references: [id])
  invoiceId         String?           @map("invoice_id")
  paymentMethod     PaymentMethod?    @relation(fields: [paymentMethodId], references: [id])
  paymentMethodId   String?           @map("payment_method_id")
  
  @@map("transactions")
  @@index([companyId])
  @@index([initiatorCompanyId])
  @@index([type])
  @@index([status])
  @@index([createdAt])
}

model UsageEvent {
  id                String            @id @default(uuid())
  companyId         String            @map("company_id") // Компания с которой списывается
  initiatorCompanyId String?          @map("initiator_company_id") // Компания которая сделала запрос
  service            String
  resource           String
  quantity           Int               @default(1)
  unit               String            @default("request")
  cost              Decimal           @db.Decimal(10, 4)
  currency           String            @default("USD")
  metadata           Json?
  timestamp          DateTime          @default(now())
  
  // Relations
  company           Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  initiatorCompany  Company?          @relation("InitiatedBy", fields: [initiatorCompanyId], references: [id], onDelete: SetNull)
  
  @@map("usage_events")
  @@index([companyId])
  @@index([initiatorCompanyId])
  @@index([service])
  @@index([timestamp])
}

model Invoice {
  id                String            @id @default(uuid())
  companyId         String            @map("company_id")
  invoiceNumber     String            @unique @map("invoice_number")
  status            InvoiceStatus     @default(DRAFT)
  subtotal          Decimal           @db.Decimal(10, 2)
  tax               Decimal           @default(0) @db.Decimal(10, 2)
  total             Decimal           @db.Decimal(10, 2)
  currency          String            @default("USD")
  dueDate           DateTime          @map("due_date")
  paidAt            DateTime?         @map("paid_at")
  createdAt         DateTime          @default(now()) @map("created_at")
  updatedAt         DateTime          @updatedAt @map("updated_at")
  
  // Relations
  company           Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  transactions      Transaction[]
  invoiceItems      InvoiceItem[]
  
  @@map("invoices")
  @@index([companyId])
  @@index([status])
  @@index([dueDate])
}

model InvoiceItem {
  id                String            @id @default(uuid())
  invoiceId         String            @map("invoice_id")
  description       String
  quantity          Int               @default(1)
  unitPrice         Decimal           @map("unit_price") @db.Decimal(10, 2)
  total             Decimal           @db.Decimal(10, 2)
  metadata           Json?
  
  // Relations
  invoice           Invoice           @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  
  @@map("invoice_items")
}

model Subscription {
  id                String            @id @default(uuid())
  companyId         String            @map("company_id")
  planId            String            @map("plan_id")
  status            SubscriptionStatus @default(ACTIVE)
  currentPeriodStart DateTime         @map("current_period_start")
  currentPeriodEnd   DateTime         @map("current_period_end")
  price             Decimal           @db.Decimal(10, 2)
  currency          String            @default("USD")
  
  // Token usage tracking
  inputTokensUsed   Int               @default(0) @map("input_tokens_used") // Использовано входных токенов
  outputTokensUsed  Int               @default(0) @map("output_tokens_used") // Использовано выходных токенов
  inputTokensLimit  Int?              @map("input_tokens_limit") // Лимит входных токенов
  outputTokensLimit Int?              @map("output_tokens_limit") // Лимит выходных токенов
  
  createdAt         DateTime          @default(now()) @map("created_at")
  updatedAt         DateTime          @updatedAt @map("updated_at")
  
  // Relations
  company           Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  plan              PricingPlan       @relation(fields: [planId], references: [id], onDelete: Cascade)
  
  @@map("subscriptions")
  @@index([companyId])
  @@index([status])
  @@index([currentPeriodEnd])
}

model PaymentMethod {
  id                String            @id @default(uuid())
  companyId         String            @map("company_id")
  type              PaymentMethodType
  provider          String
  externalId        String            @map("external_id")
  isDefault          Boolean          @default(false) @map("is_default")
  metadata           Json?
  createdAt         DateTime          @default(now()) @map("created_at")
  updatedAt         DateTime          @updatedAt @map("updated_at")
  
  // Relations
  company           Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  transactions      Transaction[]
  
  @@map("payment_methods")
  @@index([companyId])
  @@index([type])
}

model PricingPlan {
  id                String            @id @default(uuid())
  name              String
  description       String?
  type              PricingType       @default(SUBSCRIPTION)
  price             Decimal           @db.Decimal(10, 2)
  currency          String            @default("USD")
  billingCycle      BillingCycle      @default(MONTHLY)
  isActive          Boolean           @default(true) @map("is_active")
  limits            Json?
  features          Json?
  
  // Token-based plan fields
  inputTokens       Int?              @map("input_tokens") // Количество включенных входных токенов
  outputTokens      Int?              @map("output_tokens") // Количество включенных выходных токенов
  inputTokenPrice   Decimal?          @map("input_token_price") @db.Decimal(10, 6) // Цена за входной токен
  outputTokenPrice  Decimal?          @map("output_token_price") @db.Decimal(10, 6) // Цена за выходной токен
  discountPercent   Decimal?          @map("discount_percent") @db.Decimal(5, 2) // Скидка в процентах (10%)
  
  createdAt         DateTime          @default(now()) @map("created_at")
  updatedAt         DateTime          @updatedAt @map("updated_at")
  
  // Relations
  subscriptions     Subscription[]
  
  @@map("pricing_plans")
  @@index([isActive])
  @@index([type])
}

model PricingRule {
  id                String            @id @default(uuid())
  name              String
  service           String
  resource          String?
  provider          String?           // openai, openrouter, yandex, etc.
  model             String?           // gpt-3.5-turbo, gpt-4, etc.
  providerType      ProviderType      @default(FOREIGN) @map("provider_type")
  type              PricingRuleType   @default(PER_TOKEN)
  price             Decimal           @db.Decimal(10, 6)
  currency          String            @default("USD")
  limits            Json?
  discounts         Json?
  isActive          Boolean           @default(true) @map("is_active")
  priority          Int               @default(0)
  validFrom         DateTime?         @map("valid_from")
  validTo           DateTime?         @map("valid_to")
  createdAt         DateTime          @default(now()) @map("created_at")
  updatedAt         DateTime          @updatedAt @map("updated_at")
  
  @@map("pricing_rules")
  @@index([service])
  @@index([resource])
  @@index([provider])
  @@index([model])
  @@index([providerType])
  @@index([isActive])
  @@index([priority])
}

model DiscountRule {
  id                String            @id @default(uuid())
  name              String
  code              String?           @unique
  type              DiscountType      @default(PERCENTAGE)
  value             Decimal           @db.Decimal(10, 4)
  currency          String?           @default("USD")
  minAmount         Decimal?          @map("min_amount") @db.Decimal(10, 2)
  maxAmount         Decimal?          @map("max_amount") @db.Decimal(10, 2)
  companyId         String?           @map("company_id")
  userTier          String?           @map("user_tier")
  isGlobal          Boolean           @default(false) @map("is_global")
  isActive          Boolean           @default(true) @map("is_active")
  validFrom         DateTime?         @map("valid_from")
  validTo           DateTime?         @map("valid_to")
  usageLimit        Int?              @map("usage_limit")
  usageCount        Int               @default(0) @map("usage_count")
  createdAt         DateTime          @default(now()) @map("created_at")
  updatedAt         DateTime          @updatedAt @map("updated_at")
  
  // Relations
  company           Company?          @relation(fields: [companyId], references: [id], onDelete: SetNull)
  
  @@map("discount_rules")
  @@index([code])
  @@index([companyId])
  @@index([isActive])
  @@index([validFrom])
  @@index([validTo])
}

model CurrencyRate {
  id                String            @id @default(uuid())
  fromCurrency      String            @map("from_currency")
  toCurrency        String            @map("to_currency")
  rate              Decimal           @db.Decimal(10, 6)
  timestamp         DateTime          @default(now())
  
  @@map("currency_rates")
  @@index([fromCurrency])
  @@index([toCurrency])
  @@index([timestamp])
}

// ===========================================
// ENUMS
// ===========================================

enum TransactionType {
  CREDIT
  DEBIT
  REFUND
  CHARGEBACK
}

enum TransactionStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
  REFUNDED
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  OVERDUE
  CANCELLED
}

enum SubscriptionStatus {
  ACTIVE
  INACTIVE
  CANCELLED
  PAST_DUE
}

enum PaymentMethodType {
  CARD
  BANK_ACCOUNT
  WALLET
  CRYPTOCURRENCY
}

enum PricingType {
  SUBSCRIPTION
  USAGE_BASED
  ONE_TIME
  FREEMIUM
  TOKEN_BASED
}

enum BillingCycle {
  DAILY
  WEEKLY
  MONTHLY
  QUARTERLY
  YEARLY
}

enum PricingRuleType {
  PER_UNIT
  PER_REQUEST
  PER_TOKEN
  PER_MINUTE
  PER_MB
  FIXED
}

enum DiscountType {
  PERCENTAGE
  FIXED_AMOUNT
  FREE_TRIAL
}

enum ProviderType {
  DOMESTIC    // Отечественные (Yandex, Sber, etc.)
  FOREIGN     // Зарубежные (OpenAI, Anthropic, etc.)
}

enum BillingMode {
  SELF_PAID     // Компания оплачивает сама
  PARENT_PAID   // Оплачивает родительская компания
}

model ReferralTransaction {
  id                String    @id @default(uuid())
  referralOwnerId   String    @map("referral_owner_id") // Компания, которая получила реферала
  referralEarnerId  String    @map("referral_earner_id") // Компания, которая заработала на реферале
  originalTransactionId String @map("original_transaction_id") // ID оригинальной транзакции
  amount            Decimal   @db.Decimal(10, 4) // Сумма реферального бонуса
  currency          String    @default("USD")
  inputTokens       Int       @map("input_tokens") // Количество входных токенов
  outputTokens      Int       @map("output_tokens") // Количество выходных токенов
  inputTokenRate    Decimal   @map("input_token_rate") @db.Decimal(10, 6) // Ставка за входные токены (10%)
  outputTokenRate   Decimal   @map("output_token_rate") @db.Decimal(10, 6) // Ставка за выходные токены (5%)
  status            ReferralTransactionStatus @default(PENDING)
  description       String?   // Описание транзакции
  metadata          Json?     // Дополнительные данные
  processedAt       DateTime? @map("processed_at")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")
  
  // Relations
  referralOwner     Company   @relation("ReferralOwner", fields: [referralOwnerId], references: [id], onDelete: Cascade)
  referralEarner    Company   @relation("ReferralEarner", fields: [referralEarnerId], references: [id], onDelete: Cascade)
  
  @@map("referral_transactions")
  @@index([referralOwnerId])
  @@index([referralEarnerId])
  @@index([originalTransactionId])
  @@index([status])
  @@index([createdAt])
}

enum ReferralTransactionStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}
