# План тестирования новых фич системы

## Обзор новых фич для тестирования

### 1. Управление сотрудниками и иерархия платежей
- Приглашение сотрудников в компанию
- Настройка billing mode (PARENT_PAID/SELF_PAID)
- Логика списания средств с начальника или сотрудника

### 2. Реферальная система
- Начисление 10% бонуса владельцу реферала
- Отслеживание реферальных транзакций
- Обновление баланса реферера

### 3. Тарифы с токенами
- Покупка подписок с токенами
- Списание токенов при запросах
- Переход на денежные списания после исчерпания токенов
- Иерархия токенов (начальник/сотрудник)

---

## Детальный план тестирования

### БЛОК 1: Управление сотрудниками и billing modes

#### Тест 1.1: Создание компании-начальника
**Цель:** Создать основную компанию для тестирования иерархии
**Шаги:**
1. Создать компанию "Test Company Owner"
2. Пополнить баланс на $100
3. Проверить, что компания создана и баланс пополнен

#### Тест 1.2: Приглашение сотрудника с PARENT_PAID
**Цель:** Проверить создание сотрудника с оплатой начальником
**Шаги:**
1. Пригласить сотрудника "employee1@test.com" с billingMode: "PARENT_PAID"
2. Проверить, что сотрудник создан как дочерняя компания
3. Проверить, что billingMode = "PARENT_PAID"
4. Проверить связь parentCompanyId

#### Тест 1.3: Приглашение сотрудника с SELF_PAID
**Цель:** Проверить создание сотрудника с самостоятельной оплатой
**Шаги:**
1. Пригласить сотрудника "employee2@test.com" с billingMode: "SELF_PAID"
2. Пополнить баланс сотрудника на $50
3. Проверить, что billingMode = "SELF_PAID"
4. Проверить независимость балансов

#### Тест 1.4: AI запрос от PARENT_PAID сотрудника
**Цель:** Проверить списание с начальника
**Шаги:**
1. Сотрудник с PARENT_PAID делает AI запрос (1000 input + 500 output токенов)
2. Проверить, что деньги списались с баланса начальника
3. Проверить, что баланс сотрудника не изменился
4. Проверить транзакцию в истории

#### Тест 1.5: AI запрос от SELF_PAID сотрудника
**Цель:** Проверить списание с собственного баланса
**Шаги:**
1. Сотрудник с SELF_PAID делает AI запрос (1000 input + 500 output токенов)
2. Проверить, что деньги списались с баланса сотрудника
3. Проверить, что баланс начальника не изменился
4. Проверить транзакцию в истории

#### Тест 1.6: Переключение billing mode
**Цель:** Проверить изменение режима оплаты
**Шаги:**
1. Сотрудник переключается с SELF_PAID на PARENT_PAID
2. Сделать AI запрос
3. Проверить, что теперь списывается с начальника
4. Переключить обратно на SELF_PAID
5. Проверить, что теперь списывается с сотрудника

### БЛОК 2: Реферальная система

#### Тест 2.1: Создание реферальной связи
**Цель:** Настроить реферальную связь между компаниями
**Шаги:**
1. Создать компанию "Referrer Company" с реферальным кодом
2. Создать компанию "Referred Company" по реферальному коду
3. Проверить, что referredBy установлен правильно
4. Проверить, что referralCodeId установлен

#### Тест 2.2: Реферальный бонус при AI запросе
**Цель:** Проверить начисление 10% бонуса рефереру
**Шаги:**
1. Referred Company делает AI запрос (2000 input + 1000 output токенов)
2. Рассчитать ожидаемый бонус: (2000 * $0.00003 + 1000 * $0.00006) * 0.1 = $0.012
3. Проверить, что на баланс Referrer Company начислен бонус $0.012
4. Проверить создание ReferralTransaction
5. Проверить, что в транзакции указаны правильные токены и ставки

#### Тест 2.3: Множественные реферальные запросы
**Цель:** Проверить накопление реферальных бонусов
**Шаги:**
1. Referred Company делает 3 AI запроса подряд
2. Проверить, что каждый запрос создает отдельную ReferralTransaction
3. Проверить, что общий бонус начислен корректно
4. Проверить историю реферальных транзакций

#### Тест 2.4: Реферальный бонус для PARENT_PAID сотрудника
**Цель:** Проверить реферальную систему в иерархии
**Шаги:**
1. Referred Company приглашает сотрудника с PARENT_PAID
2. Сотрудник делает AI запрос
3. Проверить, что реферальный бонус начислен Referrer Company
4. Проверить, что списание произошло с Referred Company (начальника)

### БЛОК 3: Тарифы с токенами

#### Тест 3.1: Создание тарифного плана с токенами
**Цель:** Настроить тариф с включенными токенами
**Шаги:**
1. Создать PricingPlan с inputTokens: 10000, outputTokens: 5000, price: $50
2. Проверить, что план создан корректно
3. Проверить поля inputTokens, outputTokens, inputTokenPrice, outputTokenPrice

#### Тест 3.2: Покупка подписки с токенами
**Цель:** Проверить покупку тарифа и начисление токенов
**Шаги:**
1. Компания покупает подписку на тариф с токенами
2. Проверить, что создана Subscription с правильными лимитами
3. Проверить, что inputTokensLimit = 10000, outputTokensLimit = 5000
4. Проверить, что inputTokensUsed = 0, outputTokensUsed = 0
5. Проверить списание $50 с баланса

#### Тест 3.3: Использование токенов из подписки
**Цель:** Проверить списание токенов вместо денег
**Шаги:**
1. Компания с активной подпиской делает AI запрос (1000 input + 500 output)
2. Проверить, что inputTokensUsed = 1000, outputTokensUsed = 500
3. Проверить, что деньги НЕ списались с баланса
4. Проверить, что создана транзакция с типом "SUBSCRIPTION_USAGE"

#### Тест 3.4: Превышение лимита токенов
**Цель:** Проверить переход на денежные списания
**Шаги:**
1. Компания использует все токены из подписки (10000 input + 5000 output)
2. Сделать еще один AI запрос (1000 input + 500 output)
3. Проверить, что токены не списались (лимит исчерпан)
4. Проверить, что деньги списались с баланса по обычным тарифам
5. Проверить, что созданы две транзакции: SUBSCRIPTION_USAGE + PAY_AS_YOU_GO

#### Тест 3.5: Токены для PARENT_PAID сотрудника
**Цель:** Проверить иерархию токенов
**Шаги:**
1. Начальник покупает подписку с токенами
2. Сотрудник с PARENT_PAID делает AI запрос
3. Проверить, что токены списались с подписки начальника
4. Проверить, что баланс сотрудника не изменился
5. Проверить, что inputTokensUsed увеличился в подписке начальника

#### Тест 3.6: Исчерпание токенов начальника сотрудником
**Цель:** Проверить переход на денежные списания в иерархии
**Шаги:**
1. Начальник с подпиской (1000 токенов) приглашает сотрудника с PARENT_PAID
2. Сотрудник использует все токены начальника
3. Сотрудник делает еще один AI запрос
4. Проверить, что теперь списываются деньги с баланса начальника
5. Проверить, что токены начальника исчерпаны

### БЛОК 4: Комплексные сценарии

#### Тест 4.1: Полная иерархия с рефералами
**Цель:** Проверить все фичи в одном сценарии
**Шаги:**
1. Создать Referrer Company с реферальным кодом
2. Создать Referred Company по реферальному коду
3. Referred Company покупает подписку с токенами
4. Referred Company приглашает сотрудника с PARENT_PAID
5. Сотрудник делает AI запрос
6. Проверить:
   - Токены списались с подписки Referred Company
   - Реферальный бонус начислен Referrer Company
   - Баланс сотрудника не изменился

#### Тест 4.2: Смешанное использование токенов и денег
**Цель:** Проверить гибридное списание
**Шаги:**
1. Компания с подпиской (5000 токенов) делает запрос на 8000 токенов
2. Проверить, что 5000 токенов списались из подписки
3. Проверить, что 3000 токенов оплатились деньгами
4. Проверить две транзакции: SUBSCRIPTION_USAGE + PAY_AS_YOU_GO

#### Тест 4.3: Множественные сотрудники с разными режимами
**Цель:** Проверить сложную иерархию
**Шаги:**
1. Создать компанию с подпиской на токены
2. Пригласить 2 сотрудников: один PARENT_PAID, один SELF_PAID
3. PARENT_PAID сотрудник делает запрос - токены списываются с начальника
4. SELF_PAID сотрудник делает запрос - деньги списываются с сотрудника
5. Проверить корректность всех транзакций

#### Тест 4.4: Реферальная цепочка
**Цель:** Проверить многоуровневую реферальную систему
**Шаги:**
1. Company A приглашает Company B по реферальному коду
2. Company B приглашает Company C по реферальному коду
3. Company C делает AI запрос
4. Проверить, что бонус начислен только Company B (прямому рефереру)
5. Проверить, что Company A не получила бонус

### БЛОК 5: Граничные случаи и ошибки

#### Тест 5.1: Недостаток средств у начальника
**Цель:** Проверить обработку ошибок при недостатке средств
**Шаги:**
1. Создать начальника с нулевым балансом
2. Пригласить сотрудника с PARENT_PAID
3. Сотрудник пытается сделать AI запрос
4. Проверить, что запрос отклонен с ошибкой "Insufficient funds"
5. Проверить, что транзакция не создана

#### Тест 5.2: Исчерпание токенов в середине запроса
**Цель:** Проверить обработку частичного использования токенов
**Шаги:**
1. Компания с подпиской (1000 токенов) делает запрос на 1500 токенов
2. Проверить, что 1000 токенов списались из подписки
3. Проверить, что 500 токенов оплатились деньгами
4. Проверить корректность расчетов

#### Тест 5.3: Переключение billing mode во время активной подписки
**Цель:** Проверить влияние смены режима на подписку
**Шаги:**
1. Сотрудник с подпиской на токены переключается с SELF_PAID на PARENT_PAID
2. Сделать AI запрос
3. Проверить, что токены списались с подписки начальника
4. Проверить, что баланс сотрудника не изменился

---

## Критерии успешного тестирования

### Для каждого теста проверить:
1. **Корректность данных в БД** - все записи созданы правильно
2. **Правильность расчетов** - суммы, токены, проценты
3. **Логику списания** - с правильного аккаунта
4. **Создание транзакций** - все транзакции записаны
5. **Обновление балансов** - балансы изменены корректно
6. **Реферальные бонусы** - начислены правильно
7. **Иерархию токенов** - токены списываются с правильного уровня

### Ожидаемые результаты:
- ✅ Все тесты проходят без ошибок
- ✅ Балансы обновляются корректно
- ✅ Транзакции создаются с правильными типами
- ✅ Реферальные бонусы начисляются точно
- ✅ Токены списываются в правильном порядке
- ✅ Иерархия платежей работает корректно

---

## Порядок выполнения тестов

1. **Подготовка** - создать тестовые компании и данные
2. **Блок 1** - тестирование сотрудников и billing modes
3. **Блок 2** - тестирование реферальной системы
4. **Блок 3** - тестирование тарифов с токенами
5. **Блок 4** - комплексные сценарии
6. **Блок 5** - граничные случаи
7. **Финализация** - проверка всех результатов

Каждый блок должен выполняться последовательно, с проверкой результатов перед переходом к следующему блоку.
