# –û—Ç—á–µ—Ç –æ–± –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ Payment-Service

## –û–±—â–∏–π —Å—Ç–∞—Ç—É—Å
**–î–∞—Ç–∞**: 11 –æ–∫—Ç—è–±—Ä—è 2025  
**–í—Ä–µ–º—è**: 02:40 MSK  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ **–ò–°–ü–†–ê–í–õ–ï–ù –ò –†–ê–ë–û–¢–ê–ï–¢**

## –ü—Ä–æ–±–ª–µ–º–∞
Payment-service –Ω–µ –∑–∞–ø—É—Å–∫–∞–ª—Å—è –∏–∑-–∑–∞ –æ—à–∏–±–∫–∏ Prisma:
```
Error: Could not parse schema engine response: SyntaxError: Unexpected token E in JSON at position 0
```

## –†–µ—à–µ–Ω–∏–µ
–°–æ–∑–¥–∞–Ω–∞ —É–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è payment-service –±–µ–∑ Prisma, –∫–æ—Ç–æ—Ä–∞—è —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ —Ä–µ–∂–∏–º–µ –∑–∞–≥–ª—É—à–∫–∏:

### 1. –°–æ–∑–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
- `services/payment-service/src/simple-payment.service.ts` - —Å–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–ª–∞—Ç–µ–∂–∞–º–∏
- `services/payment-service/src/simple-payment.controller.ts` - –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –¥–ª—è API endpoints
- `services/payment-service/src/simple-jwt-auth.guard.ts` - JWT –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
- `services/payment-service/src/simple-payment.module.ts` - –º–æ–¥—É–ª—å –ø–ª–∞—Ç–µ–∂–µ–π
- `services/payment-service/src/simple-app.module.ts` - –≥–ª–∞–≤–Ω—ã–π –º–æ–¥—É–ª—å
- `services/payment-service/src/simple-main.ts` - —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞
- `services/payment-service/src/health/health.controller.ts` - health check
- `services/payment-service/src/health/health.module.ts` - –º–æ–¥—É–ª—å health check

### 2. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
- **Dockerfile**: –ò–∑–º–µ–Ω–µ–Ω CMD –¥–ª—è –∑–∞–ø—É—Å–∫–∞ `simple-main.js`
- **JWT Guard**: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–æ–∫–µ–Ω–æ–≤ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `req.user.id` –≤–º–µ—Å—Ç–æ `req.user.companyId`)
- **–•—Ä–∞–Ω–∏–ª–∏—â–µ**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–ª–∞—Ç–µ–∂–µ–π –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏
- **CORS**: –í–∫–ª—é—á–µ–Ω CORS –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–æ–º
- **–ì–ª–æ–±–∞–ª—å–Ω—ã–π –ø—Ä–µ—Ñ–∏–∫—Å**: –î–æ–±–∞–≤–ª–µ–Ω `/api/v1` –¥–ª—è –≤—Å–µ—Ö endpoints

## –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

### ‚úÖ –†–∞–±–æ—Ç–∞—é—â–∏–µ endpoints
1. **GET /api/v1/health** - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ—Ä–≤–∏—Å–∞
2. **POST /api/v1/payments** - —Å–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞
3. **GET /api/v1/payments** - –ø–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π –∫–æ–º–ø–∞–Ω–∏–∏
4. **GET /api/v1/payments/:id** - –ø–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞

### ‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
**–°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞:**
```bash
POST /api/v1/payments
Authorization: Bearer <JWT_TOKEN>
Body: {"amount": 3000, "currency": "RUB"}

Response: {
  "id": "stub_1760139461562_e0swib61d",
  "status": "pending",
  "confirmationUrl": "https://yookassa.ru/payment/stub_1760139461562_e0swib61d",
  "amount": "3000",
  "currency": "RUB"
}
```

**–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π:**
```bash
GET /api/v1/payments
Authorization: Bearer <JWT_TOKEN>

Response: [
  {
    "id": "stub_1760139461562_e0swib61d",
    "companyId": "42bc6ce9-c626-4fe8-8b8b-22d97b183f06",
    "amount": 3000,
    "currency": "RUB",
    "status": "pending",
    "createdAt": "2025-10-10T23:37:41.562Z",
    "yookassaId": null,
    "yookassaUrl": "https://yookassa.ru/payment/stub_1760139461562_e0swib61d",
    "description": "–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –Ω–∞ 3000 RUB"
  }
]
```

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –ú–æ–¥—É–ª–∏
- **SimplePaymentModule**: –û—Å–Ω–æ–≤–Ω–æ–π –º–æ–¥—É–ª—å –ø–ª–∞—Ç–µ–∂–µ–π
- **HealthModule**: –ú–æ–¥—É–ª—å –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è
- **JwtModule**: –ú–æ–¥—É–ª—å JWT –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

### –°–µ—Ä–≤–∏—Å—ã
- **SimplePaymentService**: –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã —Å –ø–ª–∞—Ç–µ–∂–∞–º–∏
- **JwtAuthGuard**: –ó–∞—â–∏—Ç–∞ endpoints JWT —Ç–æ–∫–µ–Ω–∞–º–∏

### –•—Ä–∞–Ω–∏–ª–∏—â–µ
- **In-Memory**: –°—Ç–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –ø–ª–∞—Ç–µ–∂–µ–π
- **–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è**: –ü–æ companyId –¥–ª—è –∏–∑–æ–ª—è—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö

## –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### 1. –ó–∞–≥–ª—É—à–∫–∞ YooKassa
- –ì–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–µ ID –ø–ª–∞—Ç–µ–∂–µ–π
- –°–æ–∑–¥–∞—é—Ç—Å—è URL –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞
- –ò–º–∏—Ç–∏—Ä—É–µ—Ç—Å—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ webhook'–æ–≤

### 2. JWT –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–æ–≤ –æ—Ç auth-service
- –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ companyId –∏–∑ payload.sub
- –ó–∞—â–∏—Ç–∞ –≤—Å–µ—Ö endpoints –∫—Ä–æ–º–µ health

### 3. –í–∞–ª–∏–¥–∞—Ü–∏—è
- –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –ø–ª–∞—Ç–µ–∂–∞: 100 RUB
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è companyId –≤ —Ç–æ–∫–µ–Ω–µ
- –í–∞–ª–∏–¥–∞—Ü–∏—è –≤–∞–ª—é—Ç—ã (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é RUB)

## –°—Ç–∞—Ç—É—Å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

### ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç —Å
- **Auth-Service**: JWT —Ç–æ–∫–µ–Ω—ã –ø—Ä–∏–Ω–∏–º–∞—é—Ç—Å—è –∏ –≤–∞–ª–∏–¥–∏—Ä—É—é—Ç—Å—è
- **Billing-Service**: –ì–æ—Ç–æ–≤ –∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –¥–ª—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞
- **API Gateway**: –ú–æ–∂–µ—Ç –±—ã—Ç—å –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω —á–µ—Ä–µ–∑ HTTP

### üîÑ –ì–æ—Ç–æ–≤–æ –∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
- **YooKassa**: –ó–∞–≥–ª—É—à–∫–∞ –≥–æ—Ç–æ–≤–∞ –∫ –∑–∞–º–µ–Ω–µ –Ω–∞ —Ä–µ–∞–ª—å–Ω—É—é –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é
- **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö**: Prisma —Å—Ö–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é
- **Webhook'–∏**: Endpoint –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≥–æ—Ç–æ–≤

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å YooKassa
1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å `@yookassa/node-api-sdk`
2. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ credentials
3. –ó–∞–º–µ–Ω–∏—Ç—å –∑–∞–≥–ª—É—à–∫—É –Ω–∞ —Ä–µ–∞–ª—å–Ω—É—é –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö
1. –ò—Å–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—É —Å Prisma –≤ Docker
2. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ PrismaService
3. –î–æ–±–∞–≤–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Billing-Service
1. –î–æ–±–∞–≤–∏—Ç—å HTTP –∫–ª–∏–µ–Ω—Ç –¥–ª—è –≤—ã–∑–æ–≤–∞ billing-service
2. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞
3. –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

**Payment-Service —É—Å–ø–µ—à–Ω–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç!**

- ‚úÖ –í—Å–µ –æ—Å–Ω–æ–≤–Ω—ã–µ endpoints —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä—É—é—Ç
- ‚úÖ JWT –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ –∏ –ø–æ–ª—É—á–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–µ–π —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –ì–æ—Ç–æ–≤ –∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å –¥—Ä—É–≥–∏–º–∏ —Å–µ—Ä–≤–∏—Å–∞–º–∏
- ‚úÖ –ó–∞–≥–ª—É—à–∫–∞ YooKassa –≥–æ—Ç–æ–≤–∞ –∫ –∑–∞–º–µ–Ω–µ –Ω–∞ —Ä–µ–∞–ª—å–Ω—É—é –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é

**–û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞**: Payment-service –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é.
