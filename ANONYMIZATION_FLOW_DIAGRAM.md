# Диаграмма потока обезличивания данных

## Полный сценарий: ФСБ включает обезличивание для OpenAI

```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   Пользователь  │    │   API Gateway    │    │   OpenAI API    │
│                 │    │                  │    │                 │
└─────────────────┘    └──────────────────┘    └─────────────────┘
         │                        │                        │
         │ 1. Запрос с личными    │                        │
         │    данными             │                        │
         ├───────────────────────►│                        │
         │                        │                        │
         │                        │ 2. Проверка настроек   │
         │                        │    ФСБ в БД            │
         │                        │                        │
         │                        │ 3. Обезличивание       │
         │                        │    данных              │
         │                        │                        │
         │                        │ 4. Обезличенный        │
         │                        │    запрос              │
         │                        ├───────────────────────►│
         │                        │                        │
         │                        │ 5. Обезличенный        │
         │                        │    ответ               │
         │                        │◄───────────────────────┤
         │                        │                        │
         │                        │ 6. Восстановление      │
         │                        │    данных в ответе     │
         │                        │                        │
         │ 7. Восстановленный     │                        │
         │    ответ с личными     │                        │
         │    данными             │                        │
         │◄───────────────────────┤                        │
         │                        │                        │
         │                        │ 8. Сохранение в        │
         │                        │    истории:            │
         │                        │    - Оригинальный      │
         │                        │      запрос            │
         │                        │    - Оригинальный      │
         │                        │      ответ (как от     │
         │                        │      нейросети)        │
```

## Детальный поток данных

### 1. Пользователь отправляет запрос
```json
{
  "messages": [
    {
      "role": "user", 
      "content": "Привет! Меня зовут Иван Петров, мой email ivan.petrov@example.com"
    }
  ],
  "model": "gpt-3.5-turbo"
}
```

### 2. API Gateway проверяет настройки ФСБ
```sql
SELECT enabled FROM anonymization_settings 
WHERE provider = 'openai' AND model = 'gpt-3.5-turbo'
```

### 3. Обезличивание данных (если включено)
```json
{
  "messages": [
    {
      "role": "user",
      "content": "Привет! Меня зовут NAME_1, мой email EMAIL_1"
    }
  ],
  "model": "gpt-3.5-turbo"
}
```

**Маппинг обезличивания:**
```json
{
  "NAME_1": "Иван Петров",
  "EMAIL_1": "ivan.petrov@example.com"
}
```

### 4. Отправка в OpenAI
Обезличенные данные отправляются в OpenAI API

### 5. Ответ от OpenAI
```json
{
  "choices": [
    {
      "message": {
        "content": "Привет NAME_1! Рад познакомиться. Вижу, что ваш email EMAIL_1"
      }
    }
  ]
}
```

### 6. Восстановление данных в ответе
```json
{
  "choices": [
    {
      "message": {
        "content": "Привет Иван Петров! Рад познакомиться. Вижу, что ваш email ivan.petrov@example.com"
      }
    }
  ]
}
```

### 7. Возврат пользователю
Пользователь получает ответ с восстановленными личными данными

### 8. Сохранение в истории (оригинальные данные)
```json
{
  "requestData": {
    "messages": [
      {
        "role": "user",
        "content": "Привет! Меня зовут Иван Петров, мой email ivan.petrov@example.com"
      }
    ]
  },
  "responseData": {
    "choices": [
      {
        "message": {
          "content": "Привет NAME_1! Рад познакомиться. Вижу, что ваш email EMAIL_1"
        }
      }
    ]
  }
}
```

**Важно:** В истории сохраняются:
- **Оригинальный запрос** (с личными данными)
- **Оригинальный ответ** (с обезличенными данными, как пришло от нейросети)
```

## Ключевые особенности

### ✅ Безопасность
- **Нейросеть не видит личные данные** - получает только обезличенные
- **Пользователь получает нормальный ответ** - данные восстановлены
- **ФСБ видит все** - оригинальные данные в истории

### ✅ Гибкость
- **ФСБ управляет настройками** - может включать/выключать для любой нейросети
- **Реальное время** - изменения применяются немедленно
- **Гранулярный контроль** - настройки для конкретных провайдеров/моделей

### ✅ Аудит
- **Полная история** - все запросы и ответы сохраняются
- **Маппинг обезличивания** - можно восстановить данные
- **Логирование действий** - все действия ФСБ записываются

## Примеры команд ФСБ

### Включить обезличивание для OpenAI
```bash
curl -X POST -H "Authorization: Bearer <fsb-token>" \
  -H "Content-Type: application/json" \
  -d '{"provider": "openai", "model": "gpt-3.5-turbo", "enabled": true}' \
  "http://localhost:3000/fsb/anonymization/settings"
```

### Отключить обезличивание
```bash
curl -X POST -H "Authorization: Bearer <fsb-token>" \
  -H "Content-Type: application/json" \
  -d '{"provider": "openai", "model": "gpt-3.5-turbo", "enabled": false}' \
  "http://localhost:3000/fsb/anonymization/settings"
```

### Посмотреть все настройки
```bash
curl -H "Authorization: Bearer <fsb-token>" \
  "http://localhost:3000/fsb/anonymization/settings"
```

## Тестирование

```bash
# 1. Создать пользователя ФСБ
./create-fsb-user.ps1

# 2. Протестировать полный поток
./test-anonymization-flow.ps1
```

Этот поток обеспечивает полную защиту личных данных пользователей при сохранении функциональности системы!
