# ФСБ Управление Обезличиванием - Отчет о реализации

## Обзор

Реализована система управления обезличиванием данных для ФСБ, позволяющая контролировать обезличивание запросов пользователей к конкретным нейросетям в реальном времени.

## Ключевые изменения

### 1. Новая архитектура управления обезличиванием

**Проблема:** Ранее обезличивание управлялось через переменные окружения и применялось ко всем запросам.

**Решение:** Создана система управления через базу данных с возможностью настройки для конкретных провайдеров и моделей.

### 2. Компоненты системы

#### AnonymizationService (services/api-gateway/src/anonymization/)
- **Управление настройками** в базе данных
- **Проверка необходимости обезличивания** для конкретного провайдера/модели
- **CRUD операции** для настроек обезличивания
- **Поиск и фильтрация** настроек

#### AnonymizationSettings (Prisma Schema)
```prisma
model AnonymizationSettings {
  id            String   @id @default(uuid())
  provider      String
  model         String
  enabled       Boolean  @default(false)
  preserveMetadata Boolean @default(true)
  createdBy     String
  updatedBy     String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([provider, model], name: "provider_model")
}
```

### 3. API эндпоинты ФСБ

#### Получение настроек обезличивания
```
GET /fsb/anonymization/settings
```
- Фильтрация по провайдеру, модели, статусу
- Пагинация результатов
- Поиск по всем настройкам

#### Создание/обновление настроек
```
POST /fsb/anonymization/settings
```
- Создание настроек для конкретного провайдера/модели
- Автоматическое обновление существующих настроек
- Логирование действий ФСБ

#### Обновление по ID
```
PUT /fsb/anonymization/settings/:id
```
- Обновление конкретных настроек
- Изменение статуса обезличивания
- Аудит изменений

#### Удаление настроек
```
DELETE /fsb/anonymization/settings/:id
```
- Удаление ненужных настроек
- Логирование удаления

### 4. Интеграция с chat.controller

#### Новая логика обезличивания
```typescript
// Проверяем настройки ФСБ для конкретного провайдера/модели
const shouldAnonymize = await this.anonymizationService.shouldAnonymize(
  provider, 
  request.model || 'gpt-3.5-turbo'
);

if (shouldAnonymize) {
  // Применяем обезличивание
  const anonymizedData = this.sharedAnonymizationService.anonymizeChatMessages(request.messages);
  requestDataToStore = {
    ...request,
    messages: anonymizedData.data
  };
}
```

#### Приоритет настроек
1. **Конкретная модель** - если есть настройки для `provider + model`
2. **Общие настройки провайдера** - если есть настройки для `provider + "*"`
3. **По умолчанию** - обезличивание отключено

## Примеры использования

### 1. Включить обезличивание для OpenAI GPT-3.5-turbo

```bash
curl -X POST -H "Authorization: Bearer <fsb-token>" \
  -H "Content-Type: application/json" \
  -d '{
    "provider": "openai",
    "model": "gpt-3.5-turbo",
    "enabled": true,
    "preserveMetadata": true
  }' \
  "http://localhost:3000/fsb/anonymization/settings"
```

### 2. Отключить обезличивание для OpenRouter GPT-4

```bash
curl -X POST -H "Authorization: Bearer <fsb-token>" \
  -H "Content-Type: application/json" \
  -d '{
    "provider": "openrouter",
    "model": "gpt-4",
    "enabled": false,
    "preserveMetadata": true
  }' \
  "http://localhost:3000/fsb/anonymization/settings"
```

### 3. Получить все настройки

```bash
curl -H "Authorization: Bearer <fsb-token>" \
  "http://localhost:3000/fsb/anonymization/settings"
```

### 4. Поиск настроек по провайдеру

```bash
curl -H "Authorization: Bearer <fsb-token>" \
  "http://localhost:3000/fsb/anonymization/settings?provider=openai"
```

## Преимущества новой системы

### 1. Гибкость управления
- **Селективное обезличивание** - можно настроить для конкретных моделей
- **Реальное время** - изменения применяются немедленно
- **Гранулярный контроль** - разные настройки для разных нейросетей

### 2. Аудит и безопасность
- **Логирование всех действий** ФСБ
- **Отслеживание изменений** настроек
- **Контроль доступа** - только пользователи с ролью 'fsb'

### 3. Производительность
- **Кэширование настроек** в памяти
- **Эффективные запросы** к базе данных
- **Минимальное влияние** на производительность

## Миграция данных

### 1. Создание таблицы
```sql
-- Миграция Prisma автоматически создаст таблицу
npx prisma migrate dev --name add_anonymization_settings
```

### 2. Перенос существующих настроек
Если есть настройки в переменных окружения, их можно перенести:

```bash
# Создать настройки для всех провайдеров
curl -X POST -H "Authorization: Bearer <fsb-token>" \
  -H "Content-Type: application/json" \
  -d '{"provider": "*", "model": "*", "enabled": true}' \
  "http://localhost:3000/fsb/anonymization/settings"
```

## Мониторинг и алерты

### 1. Логи ФСБ
- Все изменения настроек логируются
- Включают ID пользователя и детали изменений
- Отдельные логи для каждого действия

### 2. Метрики
- Количество изменений настроек
- Частота обезличивания по провайдерам
- Ошибки в процессе обезличивания

### 3. Алерты
- Неудачные попытки изменения настроек
- Ошибки в процессе обезличивания
- Подозрительная активность ФСБ

## Тестирование

### 1. Создание пользователя ФСБ
```bash
./create-fsb-user.ps1
```

### 2. Тестирование функциональности
```bash
./test-fsb-functionality.ps1
```

### 3. Ручное тестирование
1. Создать настройки обезличивания
2. Отправить запрос к нейросети
3. Проверить, что данные обезличены в истории
4. Изменить настройки
5. Повторить тест

## Заключение

Реализована полнофункциональная система управления обезличиванием для ФСБ:

- ✅ **Гибкое управление** - настройки для конкретных провайдеров/моделей
- ✅ **Реальное время** - изменения применяются немедленно
- ✅ **Полный аудит** - все действия логируются
- ✅ **Безопасность** - только ФСБ может управлять настройками
- ✅ **Производительность** - минимальное влияние на систему
- ✅ **Простота использования** - интуитивные API эндпоинты

Система готова к использованию и позволяет ФСБ эффективно управлять обезличиванием данных пользователей в зависимости от используемых нейросетей.
